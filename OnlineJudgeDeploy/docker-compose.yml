services:
  # Redis服务
  oj-redis:
    image: redis:6-alpine
    restart: always
    container_name: oj-redis-dev
    ports:
      - "6380:6379"
    volumes:
      - ./data/redis:/data
    networks:
      - oj-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # PostgreSQL数据库
  oj-postgres:
    image: postgres:13-alpine
    restart: always
    container_name: oj-postgres-dev
    ports:
      - "5435:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=onlinejudge
      - POSTGRES_USER=onlinejudge
      - POSTGRES_PASSWORD=onlinejudge
    networks:
      - oj-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # 判题服务器
  oj-judge:
    build:
      context: ../JudgeServer
      dockerfile: Dockerfile
    image: oj/judge_server:dev
    restart: always
    container_name: oj-judge-dev
    read_only: false
    # 完全移除cap_drop限制
    # cap_drop: []
    tmpfs:
      - /tmp
    volumes:
      - ./data/backend/test_case:/test_case:ro
      - ./data/judge_server/log:/log
      - ./data/judge_server/run:/judger
    environment:
      - SERVICE_URL=http://oj-judge-dev:8080
      - BACKEND_URL=http://oj-backend-dev:8000/api/judge_server_heartbeat/
      - TOKEN=5a1b3c9f4e7d8a2b6c0e1f5d9a3b7c4e #测试用的token 无任何实际意义
    networks:
      - oj-network
    ports:
      - "12358:8080"
    privileged: true
    # 添加所有必要的系统能力
    cap_add:
      - ALL
    security_opt:
      - seccomp=unconfined
    dns:
      - 202.114.96.1
      - 8.8.8.8
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # 后端开发服务
  oj-backend:
    build:
      context: ../OnlineJudge
      dockerfile: Dockerfile.dev
    image: oj/backend:dev
    container_name: oj-backend-dev
    depends_on:
      - oj-redis
      - oj-postgres
    volumes:
      - ../OnlineJudge:/app
      - ./data/backend:/data
    environment:
      - POSTGRES_HOST=oj-postgres-dev
      - POSTGRES_PORT=5432
      - POSTGRES_DB=onlinejudge
      - POSTGRES_USER=onlinejudge
      - POSTGRES_PASSWORD=onlinejudge
      - REDIS_HOST=oj-redis-dev
      - REDIS_PORT=6379
      - JUDGE_SERVER_TOKEN=5a1b3c9f4e7d8a2b6c0e1f5d9a3b7c4e #测试用的token 无任何实际意义
    ports:
      - "8000:8000"
    networks:
      - oj-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # 前端开发服务
  oj-frontend:
    build:
      context: ../OnlineJudgeFE
      dockerfile: Dockerfile.dev
    image: oj/frontend:dev
    container_name: oj-frontend-dev
    volumes:
      - ../OnlineJudgeFE:/OJ_FE
      - /OJ_FE/node_modules
    environment:
      - NODE_ENV=development
      - TARGET=http://oj-backend-dev:8000
      - PORT=8081
    ports:
      - "8081:8081"
    dns:
      - 202.114.96.1
      - 8.8.8.8 # 备用：Google 公共 DNS
    networks:
      - oj-network
    depends_on:
      - oj-backend
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

# 网络定义
networks:
  oj-network:
    driver: bridge
