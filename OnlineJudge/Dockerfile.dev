FROM python:3.11-slim

WORKDIR /app

# 安装编译依赖
RUN apt-get update && apt-get install -y \
    gcc \
    python3-dev \
    libpq-dev \
    libjpeg-dev \
    zlib1g-dev \
    libfreetype6-dev \
    gfortran \
    && rm -rf /var/lib/apt/lists/*

# 升级 pip 并安装 setuptools 和 wheel
RUN pip install --upgrade pip setuptools wheel

# 先安装预编译的科学计算库（使用特定版本以确保有预编译包）
RUN pip install --only-binary=all numpy==1.24.3
RUN pip install --only-binary=all scipy==1.11.4
RUN pip install --only-binary=all scikit-learn==1.3.0

# 安装 requirements.txt 中的依赖
COPY ./deploy/requirements.txt /app/deploy/
RUN pip install --no-cache-dir -r /app/deploy/requirements.txt

# 创建 NLTK 数据目录并下载 NLTK 数据
RUN mkdir -p /usr/share/nltk_data && \
    python -c "import nltk; nltk.download('punkt', download_dir='/usr/share/nltk_data'); nltk.download('stopwords', download_dir='/usr/share/nltk_data')" || \
    echo "Warning: Failed to download NLTK data during build" && \
    chmod -R 777 /usr/share/nltk_data
# 设置 NLTK_DATA 环境变量
ENV NLTK_DATA=/usr/share/nltk_data

# 复制代码
COPY ./ /app/

# 收集静态文件
RUN python manage.py collectstatic --no-input

EXPOSE 8000

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "oj.wsgi"]